FROM node:18.17.1

WORKDIR /app/

COPY ./package*.json ./
COPY ./src/ ./src/
COPY ./astro.config.mjs ./
COPY ./tsconfig.json ./

ARG API_TARGET_AUDIENCE
ENV API_TARGET_AUDIENCE=${API_TARGET_AUDIENCE}

RUN npm install -g npm@9.6.7 && \
	npm ci --production && \
	npm run build

EXPOSE 4001

CMD node ./dist/server/entry.mjs
